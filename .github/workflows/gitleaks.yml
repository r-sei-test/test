name: gitleaks

on:
  pull_request:
  push:
  schedule:
    - cron: "0 4 * * *"   # daily at 04:00 UTC
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref || github.run_id }}
  cancel-in-progress: true

# Default-deny; job elevates only what's needed
permissions:
  contents: read

jobs:
  scan:
    name: Gitleaks scan â†’ Code Scanning
    runs-on: ubuntu-24.04
    timeout-minutes: 20
    permissions:
      contents: read
      security-events: write   # needed to upload SARIF
      actions: read            # required in private repos for upload-sarif

    # Keep paths relative to the workspace; no /github/... anywhere
    env:
      REPORT_PATH: gitleaks.sarif

    steps:
      # Harden egress (audit first; later switch to block + allowlist)
      - name: Harden runner (egress audit)
        uses: step-security/harden-runner@ec9f2d5744a09debf3a187a3f4f675c53b671911 # v2.13.0
        with:
          egress-policy: audit

      # Checkout with no persisted creds (we're not pushing)
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false
          fetch-depth: 0

      # Run Gitleaks; report goes to ./gitleaks.sarif in the workspace.
      # continue-on-error keeps the job alive so the upload step runs even if leaks are found.
      - name: Run Gitleaks
        id: gitleaks
        continue-on-error: true
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7 # v2.3.9
        with:
          args: >-
            detect
            --source .
            --redact
            --no-banner
            --verbose
            --report-format sarif
            --report-path "${{ env.REPORT_PATH }}"
          # config-path: .gitleaks.toml   # uncomment if you maintain a baseline/allowlist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      # Upload SARIF to Code Scanning; run regardless of Gitleaks exit code
      - name: Upload SARIF to Code Scanning
        if: always() && hashFiles('gitleaks.sarif') != ''
        uses: github/codeql-action/upload-sarif@3c3833e0f8c1c83d449a7478aa59c036a9165498 # v3.29.11
        with:
          sarif_file: ${{ env.REPORT_PATH }}
          category: gitleaks
